@page "/lotes"
@rendermode InteractiveServer
@using System
@using System.Collections.Generic
@using System.ComponentModel.DataAnnotations
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using System.Linq
@using SistemaFacturacionSRI.Application.DTOs.Lote
@using SistemaFacturacionSRI.Application.DTOs.Producto
@using SistemaFacturacionSRI.WebUI.Services
@inject LoteHttpService LoteService
@inject ProductoHttpService ProductoService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Gestión de Lotes</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1 text-dark">
                <i class="bi bi-boxes me-2" style="color: #1e3a5f;"></i>
                Gestión de Lotes e Inventario
            </h2>
            <p class="text-secondary mb-0">Control y seguimiento de lotes de productos</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/lotes/nuevo" class="btn btn-corporate btn-lg shadow-sm">
                <i class="bi bi-plus-circle me-2"></i>Nuevo Lote
            </a>
        </div>
    </div>

    <!-- Alertas -->
    @if (!PuedeCrearLotes && !cargando)
    {
        <div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Información:</strong> Debe registrar al menos un producto antes de crear lotes.
            <button type="button" class="btn-close" @onclick="() => {}" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Error:</strong> @mensajeError
            <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Éxito:</strong> @mensajeExito
            <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
        </div>
    }

    <!-- Filtros y Estadísticas -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center g-3">
                <div class="col-lg-4">
                    <label class="form-label fw-bold text-dark mb-2">
                        <i class="bi bi-search me-2"></i>Buscar Lotes
                    </label>
                    <div class="input-group input-group-lg shadow-sm">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-funnel text-secondary"></i>
                        </span>
                        <input class="form-control border-start-0 ps-0" 
                            @bind="textoBusqueda" 
                            @bind:event="oninput" 
                            placeholder="Buscar por nombre o código de producto..." />
                        @if (!string.IsNullOrWhiteSpace(textoBusqueda))
                        {
                            <button class="btn btn-outline-secondary" @onclick="() => textoBusqueda = string.Empty">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }
                    </div>
                </div>
                <div class="col-lg-4">
                    <label class="form-label fw-bold text-dark mb-2">
                        <i class="bi bi-tag me-2"></i>Filtrar por Categoría
                    </label>
                    <input class="form-control form-control-lg" @bind="filtroCategoria" @bind:event="oninput" placeholder="Nombre de la categoría..." />
                </div>
                <div class="col-lg-4">
                    <label class="form-label fw-bold text-dark mb-2">
                        <i class="bi bi-calendar-date me-2"></i>Filtrar por Fecha de Compra
                    </label>
                    <InputDate class="form-control form-control-lg" @bind-Value="filtroFecha" />
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Lotes -->
    @if (cargando)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-corporate mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted mb-0">Cargando información de lotes...</p>
            </div>
        </div>
    }
    else if (lotes == null || lotes.Count == 0)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox text-secondary" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-dark">No hay lotes registrados</h4>
                <p class="text-secondary mb-4">Comience agregando su primer lote de inventario</p>
                <a href="/lotes/nuevo" class="btn btn-corporate btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>Crear Primer Lote
                </a>
            </div>
        </div>
    }
    else if (!LotesFiltrados.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-search text-secondary" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-dark">No se encontraron resultados</h4>
                <p class="text-secondary mb-3">No hay lotes que coincidan con los filtros aplicados.</p>
                <button class="btn btn-outline-secondary" @onclick="() => { textoBusqueda = string.Empty; filtroCategoria = string.Empty; filtroFecha = null; }">
                    <i class="bi bi-x-circle me-2"></i>Limpiar filtros
                </button>
            </div>
        </div>
    }
    else
    {
    <div class="alert alert-secondary">
        Mostrando <strong>@LotesFiltrados.Count()</strong> de <strong>@lotes.Count</strong> lotes
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th class="px-4 py-3">
                        <i class="bi bi-hash me-1"></i>Lote
                    </th>
                    <th class="py-3">Producto</th>
                    <th class="py-3">Código</th>
                    <th class="py-3">Categoría</th>
                    <th class="py-3">
                        <i class="bi bi-calendar-check me-1"></i>Compra
                    </th>
                    <th class="py-3">
                        <i class="bi bi-calendar-x me-1"></i>Expiración
                    </th>
                    <th class="py-3">
                        <i class="bi bi-currency-dollar me-1"></i>Costo
                    </th>
                    <th class="py-3">
                        <i class="bi bi-currency-dollar me-1"></i>PVP
                    </th>
                    <th class="py-3 text-center">Inicial</th>
                    <th class="py-3 text-center">Disponible</th>
                    <th class="py-3 text-center" style="width: 10%;">Acciones</th>

                </tr>
            </thead>
                    <tbody>
                        @foreach (var lote in LotesFiltrados)
                        {
                            var diasParaVencer = lote.FechaExpiracion.HasValue 
                                ? (lote.FechaExpiracion.Value.Date - DateTime.Today).Days 
                                : int.MaxValue;
                            var colorVencimiento = ObtenerColorVencimiento(diasParaVencer);
                            var sinStock = lote.CantidadDisponible == 0;

                            <tr class="@(sinStock ? "table-light" : "")">
                                <td class="px-4">
                                    <span class="badge bg-dark fs-6 px-3 py-2">
                                        #@lote.LoteId
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold text-dark">@lote.ProductoNombre</span>
                                        <small class="text-secondary">
                                            <i class="bi bi-tag-fill me-1"></i>ID: @lote.ProductoId
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <code class="bg-light px-2 py-1 rounded text-dark border">@lote.ProductoCodigo</code>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(lote.ProductoCategoria))
                                    {
                                        <span class="badge bg-secondary">@lote.ProductoCategoria</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Sin categoría</span>
                                    }
                                </td>
                                <td>
                                    <span class="text-secondary">
                                        @lote.FechaCompra.ToString("dd/MM/yyyy")
                                    </span>
                                </td>
                                <td>
                                    @if (lote.FechaExpiracion.HasValue)
                                    {
                                        <div class="d-flex flex-column">
                                            <span class="@colorVencimiento">
                                                @lote.FechaExpiracion.Value.ToString("dd/MM/yyyy")
                                            </span>
                                            @if (diasParaVencer < 0)
                                            {
                                                <small class="text-danger fw-bold">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                    Vencido
                                                </small>
                                            }
                                            else if (diasParaVencer <= 30)
                                            {
                                                <small class="@colorVencimiento">
                                                    <i class="bi bi-clock-fill me-1"></i>
                                                    @diasParaVencer días
                                                </small>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-infinity"></i> Sin vencer
                                        </span>
                                    }
                                </td>
                                <td>
                                    <span class="fw-bold text-dark">
                                        $@lote.PrecioCosto.ToString("N2")
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-bold text-primary">
                                        $@lote.PVP.ToString("N2")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark border">
                                        @lote.CantidadInicial
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge @(lote.CantidadDisponible > 0 ? "bg-success" : "bg-danger") fs-6 px-3 py-2">
                                        <i class="bi @(lote.CantidadDisponible > 0 ? "bi-check-circle" : "bi-x-circle") me-1"></i>
                                        @lote.CantidadDisponible
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex flex-column gap-1">
                                        <a href="/lotes/editar/@lote.LoteId" class="btn btn-sm btn-warning w-100">
                                            <i class="bi bi-pencil me-1"></i>
                                            Editar
                                        </a>
                                        <button class="btn btn-sm btn-danger w-100" 
                                                @onclick="() => MostrarConfirmacionEliminar(lote)" 
                                                disabled="@(lote.CantidadDisponible > 0)"
                                                title="@(lote.CantidadDisponible > 0 ? "No se puede eliminar: tiene stock disponible" : "")">
                                            <i class="bi bi-trash me-1"></i>
                                            Eliminar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
    }
</div>

@* Modal de confirmación para eliminar *@
@if (mostrarModalEliminar)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelarEliminar"></button>
                </div>
                <div class="modal-body">
                    @if (loteAEliminar != null)
                    {
                        <p class="mb-3">¿Está seguro que desea eliminar el siguiente lote?</p>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1"><strong>Lote ID:</strong> #@loteAEliminar.LoteId</p>
                                <p class="mb-1"><strong>Producto:</strong> @loteAEliminar.ProductoNombre</p>
                                <p class="mb-1"><strong>Código:</strong> @loteAEliminar.ProductoCodigo</p>
                                <p class="mb-1"><strong>Precio Costo:</strong> $@loteAEliminar.PrecioCosto.ToString("N2")</p>
                                <p class="mb-0">
                                    <strong>Stock Disponible:</strong> 
                                    <span class="badge @(loteAEliminar.CantidadDisponible > 0 ? "bg-danger" : "bg-secondary")">
                                        @loteAEliminar.CantidadDisponible unidades
                                    </span>
                                </p>
                            </div>
                        </div>

                        @if (loteAEliminar.CantidadDisponible > 0)
                        {
                            <div class="alert alert-danger mt-3 mb-0">
                                <i class="bi bi-exclamation-octagon-fill me-2"></i>
                                <strong>¡Atención!</strong> Este lote tiene <strong>@loteAEliminar.CantidadDisponible unidades</strong> en stock disponible. 
                                No podrá ser eliminado hasta que el stock llegue a 0.
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mt-3 mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Advertencia:</strong> Esta acción no se puede deshacer.
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelarEliminar" disabled="@eliminando">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmarEliminar" disabled="@GetDisabledEliminar()">
                        @if (eliminando)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Eliminando...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash"></i>
                            <span> Eliminar</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    :root {
        --corporate-primary: #1e3a5f;
        --corporate-secondary: #2c5282;
        --corporate-light: #e8eef5;
    }

    .bg-corporate {
        background-color: var(--corporate-primary) !important;
    }

    .bg-corporate-light {
        background-color: var(--corporate-light) !important;
    }

    .text-corporate {
        color: var(--corporate-primary) !important;
    }

    .btn-corporate {
        background-color: var(--corporate-primary);
        border-color: var(--corporate-primary);
        color: white;
    }

    .btn-corporate:hover {
        background-color: var(--corporate-secondary);
        border-color: var(--corporate-secondary);
        color: white;
    }

    .btn-corporate:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .animate-slide-down {
        animation: slideDown 0.3s ease-out;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }
</style>

@code {
    private List<LoteDto>? lotes;
    private List<ProductoDto> productos = new();
    private bool cargando = true;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string textoBusqueda = string.Empty;
    private string filtroCategoria = string.Empty;
    private DateTime? filtroFecha;
    
    // Variables para eliminación
    private bool mostrarModalEliminar = false;
    private bool eliminando = false;
    private LoteDto? loteAEliminar = null;

    private bool PuedeCrearLotes => productos.Count > 0;

    private IEnumerable<LoteDto> LotesFiltrados
    {
        get
        {
            var lotesFiltrados = lotes ?? Enumerable.Empty<LoteDto>();

            if (!string.IsNullOrWhiteSpace(textoBusqueda))
            {
                lotesFiltrados = lotesFiltrados.Where(l =>
                    (l.ProductoNombre?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (l.ProductoCodigo?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            if (!string.IsNullOrWhiteSpace(filtroCategoria))
            {
                lotesFiltrados = lotesFiltrados.Where(l =>
                    l.ProductoCategoria?.Contains(filtroCategoria, StringComparison.OrdinalIgnoreCase) ?? false);
            }

            if (filtroFecha.HasValue)
            {
                lotesFiltrados = lotesFiltrados.Where(l => l.FechaCompra.Date == filtroFecha.Value.Date);
            }

            return lotesFiltrados;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            cargando = true;
            mensajeError = string.Empty;
            mensajeExito = string.Empty;

            var lotesObtenidos = await LoteService.ObtenerTodosAsync();
            lotes = lotesObtenidos?.ToList() ?? new List<LoteDto>();
            OrdenarLotes();

            var productosObtenidos = await ProductoService.ObtenerTodosAsync();
            productos = (productosObtenidos ?? new List<ProductoDto>())
                .OrderBy(p => p.Nombre)
                .ToList();
        }
        catch (Exception ex)
        {
            mensajeError = ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    private void OrdenarLotes()
    {
        if (lotes == null || lotes.Count == 0) return;
        lotes = lotes
            .OrderByDescending(l => l.FechaCompra)
            .ThenByDescending(l => l.LoteId)
            .ToList();
    }

    private string ObtenerColorVencimiento(int dias)
    {
        if (dias < 0) return "text-danger fw-bold";
        if (dias <= 7) return "text-danger fw-bold";
        if (dias <= 30) return "text-warning fw-bold";
        return "text-secondary";
    }

    // ========================================
    // MÉTODOS PARA ELIMINAR
    // ========================================

    private void MostrarConfirmacionEliminar(LoteDto lote)
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
        loteAEliminar = lote;
        mostrarModalEliminar = true;
    }

    private void CancelarEliminar()
    {
        mostrarModalEliminar = false;
        loteAEliminar = null;
    }

    private async Task ConfirmarEliminar()
    {
        if (loteAEliminar == null) return;
        var loteId = loteAEliminar.LoteId;
        var productoNombre = loteAEliminar.ProductoNombre;

        try
        {
            eliminando = true;
            mensajeError = string.Empty;
            mensajeExito = string.Empty;

            await LoteService.EliminarAsync(loteId);

            lotes?.RemoveAll(l => l.LoteId == loteId);

            mensajeExito = $"Lote #{loteId} del producto '{productoNombre}' eliminado exitosamente.";

            mostrarModalEliminar = false;
            loteAEliminar = null;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("stock disponible", StringComparison.OrdinalIgnoreCase) ||
                ex.Message.Contains("tiene") && ex.Message.Contains("unidades"))
            {
                mensajeError = $"No se puede eliminar el lote #{loteId} porque tiene stock disponible.";
            }
            else
            {
                mensajeError = $"Error al eliminar el lote #{loteId}: {ex.Message}";
            }

            mostrarModalEliminar = false;
            loteAEliminar = null;
        }
        finally
        {
            eliminando = false;
        }
    }

    private bool GetDisabledEliminar()
    {
        if (eliminando) return true;
        if (loteAEliminar == null) return false;
        return loteAEliminar.CantidadDisponible > 0;
    }
}
