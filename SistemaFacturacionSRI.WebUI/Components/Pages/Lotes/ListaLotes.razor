@page "/lotes"
@rendermode InteractiveServer
@using System
@using System.Collections.Generic
@using System.ComponentModel.DataAnnotations
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using System.Linq
@using SistemaFacturacionSRI.Application.DTOs.Lote
@using SistemaFacturacionSRI.Application.DTOs.Producto
@using SistemaFacturacionSRI.WebUI.Services
@inject LoteHttpService LoteService
@inject ProductoHttpService ProductoService

<PageTitle>Lotes</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Inventario de Lotes</h3>
        <button type="button" class="btn btn-primary" @onclick="MostrarFormulario" disabled="@(!PuedeCrearLotes || cargando)">
            <i class="bi bi-plus-circle me-2"></i>Agregar lote
        </button>
    </div>

    @if (!PuedeCrearLotes && !cargando)
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle me-2"></i>Registra al menos un producto para poder crear lotes.
        </div>
    }

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@mensajeError
        </div>
    }

    @if (!string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle me-2"></i>@mensajeExito
        </div>
    }

    @if (mostrandoFormulario)
    {
        <div class="card mb-3 border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Agregar nuevo lote</span>
                <button type="button" class="btn btn-sm btn-light" @onclick="CancelarCreacion" aria-label="Cerrar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="card-body">
                <EditForm Model="@loteForm" OnValidSubmit="CrearLoteAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Producto</label>
                            <InputSelect class="form-select" @bind-Value="loteForm.ProductoId">
                                <option value="">Seleccione un producto</option>
                                @foreach (var producto in productos)
                                {
                                    <option value="@producto.Id">@producto.Nombre (@producto.Codigo)</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => loteForm.ProductoId)" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Fecha de compra</label>
                            <InputDate @bind-Value="loteForm.FechaCompra" class="form-control" />
                            <ValidationMessage For="@(() => loteForm.FechaCompra)" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Fecha de expiración</label>
                            <InputDate @bind-Value="loteForm.FechaExpiracion" class="form-control" />
                            <ValidationMessage For="@(() => loteForm.FechaExpiracion)" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Precio costo</label>
                            <InputNumber @bind-Value="loteForm.PrecioCosto" class="form-control" step="0.01" min="0" />
                            <ValidationMessage For="@(() => loteForm.PrecioCosto)" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Cantidad inicial</label>
                            <InputNumber @bind-Value="loteForm.CantidadInicial" class="form-control" min="1" />
                            <ValidationMessage For="@(() => loteForm.CantidadInicial)" />
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-outline-secondary" @onclick="CancelarCreacion" disabled="@creandoLote">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@creandoLote">
                            @if (creandoLote)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Guardar lote
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Buscar por producto:</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input class="form-control" @bind="textoBusqueda" @bind:event="oninput" placeholder="Nombre o código del producto" />
                    </div>
                </div>
                <div class="col-md-6 d-flex align-items-end justify-content-end">
                    <span class="text-muted">Total de lotes: <strong>@(lotes?.Count ?? 0)</strong></span>
                </div>
            </div>
        </div>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Cargando lotes...</p>
        </div>
    }
    else if (lotes == null || lotes.Count == 0)
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-box-seam fs-1"></i>
            <p class="mt-2 mb-0">Aún no se registran lotes.</p>
        </div>
    }
    else if (!LotesFiltrados.Any())
    {
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-triangle fs-1"></i>
            <p class="mt-2 mb-0">No se encontraron lotes con el filtro aplicado.</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 8%;">Lote</th>
                        <th style="width: 14%;">Producto</th>
                        <th style="width: 12%;">Código</th>
                        <th style="width: 12%;">Categoría</th>
                        <th style="width: 12%;">Fecha compra</th>
                        <th style="width: 12%;">Fecha expiración</th>
                        <th style="width: 10%;">Precio costo</th>
                        <th style="width: 10%;">Cantidad inicial</th>
                        <th style="width: 10%;">Disponible</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var lote in LotesFiltrados)
                    {
                        <tr>
                            <td><span class="badge bg-secondary">#@lote.LoteId</span></td>
                            <td>
                                <div class="fw-semibold">@lote.ProductoNombre</div>
                                <small class="text-muted">ID: @lote.ProductoId</small>
                            </td>
                            <td><code>@lote.ProductoCodigo</code></td>
                            <td>@(string.IsNullOrEmpty(lote.ProductoCategoria) ? "-" : lote.ProductoCategoria)</td>
                            <td>@lote.FechaCompra.ToString("dd/MM/yyyy")</td>
                            <td>@(lote.FechaExpiracion.HasValue ? lote.FechaExpiracion.Value.ToString("dd/MM/yyyy") : "Sin caducar")</td>
                            <td>$@lote.PrecioCosto.ToString("N2")</td>
                            <td>@lote.CantidadInicial</td>
                            <td>
                                <span class="badge @(lote.CantidadDisponible > 0 ? "bg-success" : "bg-danger")">
                                    @lote.CantidadDisponible
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<LoteDto>? lotes;
    private List<ProductoDto> productos = new();
    private CrearLoteFormModel loteForm = new();
    private bool cargando = true;
    private bool mostrandoFormulario;
    private bool creandoLote;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string textoBusqueda = string.Empty;

    private bool PuedeCrearLotes => productos.Count > 0;

    private IEnumerable<LoteDto> LotesFiltrados
        => string.IsNullOrWhiteSpace(textoBusqueda)
            ? lotes ?? Enumerable.Empty<LoteDto>()
            : (lotes ?? Enumerable.Empty<LoteDto>()).Where(l =>
                (l.ProductoNombre?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (l.ProductoCodigo?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ?? false));

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargando = true;
            mensajeError = string.Empty;
            mensajeExito = string.Empty;

            var lotesObtenidos = await LoteService.ObtenerTodosAsync();
            lotes = lotesObtenidos?.ToList() ?? new List<LoteDto>();
            OrdenarLotes();

            var productosObtenidos = await ProductoService.ObtenerTodosAsync();
            productos = (productosObtenidos ?? new List<ProductoDto>())
                .OrderBy(p => p.Nombre)
                .ToList();
        }
        catch (Exception ex)
        {
            mensajeError = ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CrearLoteAsync()
    {
        if (creandoLote)
        {
            return;
        }

        if (loteForm.ProductoId is null || loteForm.FechaCompra is null || loteForm.PrecioCosto is null || loteForm.CantidadInicial is null)
        {
            return;
        }

        try
        {
            creandoLote = true;
            mensajeError = string.Empty;
            mensajeExito = string.Empty;

            var dto = new CrearLoteDto
            {
                ProductoId = loteForm.ProductoId.Value,
                FechaCompra = loteForm.FechaCompra.Value,
                FechaExpiracion = loteForm.FechaExpiracion,
                PrecioCosto = loteForm.PrecioCosto.Value,
                CantidadInicial = loteForm.CantidadInicial.Value
            };

            var loteCreado = await LoteService.CrearAsync(dto);

            if (lotes == null)
            {
                lotes = new List<LoteDto>();
            }

            lotes.Add(loteCreado);
            OrdenarLotes();

            mensajeExito = $"Lote #{loteCreado.LoteId} creado correctamente.";
            mostrandoFormulario = false;
            ResetFormulario();
        }
        catch (Exception ex)
        {
            mensajeError = ex.Message;
        }
        finally
        {
            creandoLote = false;
        }
    }

    private void MostrarFormulario()
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;

        if (!PuedeCrearLotes || cargando)
        {
            return;
        }

        if (!mostrandoFormulario)
        {
            ResetFormulario();
        }

        mostrandoFormulario = !mostrandoFormulario;
    }

    private void CancelarCreacion()
    {
        mostrandoFormulario = false;
        ResetFormulario();
    }

    private void ResetFormulario()
    {
        loteForm = new CrearLoteFormModel();
    }

    private void OrdenarLotes()
    {
        if (lotes == null || lotes.Count == 0)
        {
            return;
        }

        lotes = lotes
            .OrderByDescending(l => l.FechaCompra)
            .ThenByDescending(l => l.LoteId)
            .ToList();
    }

    private sealed class CrearLoteFormModel
    {
        public CrearLoteFormModel()
        {
            FechaCompra = DateTime.Today;
        }

        [Required(ErrorMessage = "Seleccione un producto")]
        public int? ProductoId { get; set; }

        [Required(ErrorMessage = "La fecha de compra es obligatoria")]
        public DateTime? FechaCompra { get; set; }

        public DateTime? FechaExpiracion { get; set; }

        [Required(ErrorMessage = "Ingrese el precio de costo")]
        [Range(0.01, double.MaxValue, ErrorMessage = "El precio de costo debe ser mayor a 0")]
        public decimal? PrecioCosto { get; set; }

        [Required(ErrorMessage = "Ingrese la cantidad inicial")]
        [Range(1, int.MaxValue, ErrorMessage = "La cantidad inicial debe ser mayor a 0")]
        public int? CantidadInicial { get; set; }
    }
}
