@page "/productos/detalles/{Id:int}"
@rendermode InteractiveServer
@using SistemaFacturacionSRI.Application.DTOs.Producto
@using SistemaFacturacionSRI.Application.DTOs.Lote
@using SistemaFacturacionSRI.WebUI.Services
@inject ProductoHttpService ProductoService
@inject LoteHttpService LoteService
@inject NavigationManager Navigation


<PageTitle>Detalle de Producto</PageTitle>

<div class="container-fluid py-4">
    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando información del producto...</p>
        </div>
    }
    else if (producto == null)
    {
        <div class="alert alert-danger shadow-sm">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Error:</strong> No se pudo cargar el producto. 
            <a href="/productos" class="alert-link">Volver a la lista</a>
        </div>
    }
    else
    {
        <!-- Header del Producto -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-box-seam text-primary me-2"></i>
                    @producto.Nombre
                </h2>
                <p class="text-muted mb-0">
                    <span class="badge bg-secondary">@producto.Codigo</span>
                    <span class="badge bg-info ms-2">@producto.CategoriaNombre</span>
                </p>
            </div>
            <button class="btn btn-outline-secondary" @onclick="Volver">
                <i class="bi bi-arrow-left me-2"></i>
                Volver
            </button>
        </div>

        <div class="row g-4">
            <!-- Columna Izquierda: Información General -->
            <div class="col-lg-4">
                <!-- Card: Información General -->
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Información General
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small mb-1">Código SKU</label>
                            <p class="fw-bold mb-0">@producto.Codigo</p>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small mb-1">Nombre</label>
                            <p class="fw-bold mb-0">@producto.Nombre</p>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small mb-1">Descripción</label>
                            <p class="mb-0">@(producto.Descripcion ?? "Sin descripción")</p>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small mb-1">Categoría</label>
                            <p class="mb-0">
                                <span class="badge bg-info">@producto.CategoriaNombre</span>
                            </p>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small mb-1">Tipo de IVA</label>
                            <p class="mb-0">
                                <span class="badge bg-secondary">@producto.TipoIVADescripcion</span>
                            </p>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <label class="text-muted small mb-1">Stock Total</label>
                            <h3 class="mb-0">
                                <span class="badge @(producto.TieneStock ? "bg-success" : "bg-danger") fs-5">
                                    @producto.Stock unidades
                                </span>
                            </h3>
                        </div>
                       

@{
    //  Calcular el lote prioritario localmente
    var lotePrioritarioCalculado = lotes?
        .Where(l => l.CantidadDisponible > 0)
        .OrderBy(l => l.FechaExpiracion ?? DateTime.MaxValue)
        .ThenBy(l => l.FechaCompra)
        .FirstOrDefault();
    
    var precioCostoLotePrioritario = lotePrioritarioCalculado?.PrecioCosto;
}

@if (precioCostoLotePrioritario.HasValue && lotePrioritarioCalculado != null)
{
    var valorIVA = precioCostoLotePrioritario.Value * producto.PorcentajeIVA;
    var precioConIVA = precioCostoLotePrioritario.Value + valorIVA;
    
    <div class="mb-3">
        <label class="text-muted small mb-1">
            Precio Base (Lote Prioritario)
            <i class="bi bi-info-circle text-primary" 
               title="Precio del lote más próximo a vencer con stock disponible"></i>
        </label>
        <h4 class="text-success mb-1">
            $@precioCostoLotePrioritario.Value.ToString("N2")
        </h4>
        <small class="text-muted">
            <i class="bi bi-tag-fill me-1"></i>
            Lote: @lotePrioritarioCalculado.LoteId
            @if (lotePrioritarioCalculado.FechaExpiracion.HasValue)
            {
                var diasVence = (lotePrioritarioCalculado.FechaExpiracion.Value.Date - DateTime.Today).Days;
                <span class="text-@(diasVence <= 7 ? "danger" : diasVence <= 30 ? "warning" : "success")">
                    (Vence en @diasVence días)
                </span>
            }
        </small>
    </div>

    <div class="mb-0">
        <label class="text-muted small mb-1">Precio con IVA</label>
        <h4 class="text-primary mb-1">$@precioConIVA.ToString("N2")</h4>
        <small class="text-muted">Incluye @((producto.PorcentajeIVA * 100).ToString("N0"))% IVA</small>
    </div>
}
else if (producto.Precio.HasValue)
{
    <div class="mb-3">
        <label class="text-muted small mb-1">Precio Base</label>
        <h4 class="text-muted mb-1">$@producto.Precio.Value.ToString("N2")</h4>
        <small class="text-warning">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Sin lote prioritario definido
        </small>
    </div>
}
else
{
    <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-1"></i>
        Este producto no tiene precio definido ni lotes disponibles
    </div>
}



                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Lotes -->
            <div class="col-lg-8">
                @if (!string.IsNullOrEmpty(producto.LotePrioritario) && producto.FechaExpiracionLotePrioritario.HasValue)
                {
                    var diasParaVencer = (producto.FechaExpiracionLotePrioritario.Value.Date - DateTime.Today).Days;
                    var colorAlert = ObtenerColorAlerta(diasParaVencer);
                    var iconoAlert = ObtenerIconoAlerta(diasParaVencer);
                    var mensajeVencimiento = ObtenerMensajeVencimiento(diasParaVencer);

                    <!-- Card: Lote Prioritario -->
                    <div class="card shadow-sm mb-4 border-@colorAlert">
                        <div class="card-header bg-@colorAlert text-white">
                            <h5 class="mb-0">
                                <i class="bi @iconoAlert me-2"></i>
                                Lote Prioritario (Próximo a Vencer)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="text-muted small mb-1">ID del Lote</label>
                                    <p class="fw-bold mb-0 fs-5">
                                        <i class="bi bi-tag-fill text-@colorAlert me-2"></i>
                                        @producto.LotePrioritario
                                    </p>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="text-muted small mb-1">Fecha de Expiración</label>
                                    <p class="fw-bold mb-0 fs-5">
                                        <i class="bi bi-calendar-x text-@colorAlert me-2"></i>
                                        @producto.FechaExpiracionLotePrioritario.Value.ToString("dd/MM/yyyy")
                                    </p>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="text-muted small mb-1">Estado</label>
                                    <p class="mb-0">
                                        <span class="badge bg-@colorAlert fs-6">
                                            @mensajeVencimiento
                                        </span>
                                    </p>
                                </div>
                            </div>

                            @if (diasParaVencer < 0)
                            {
                                <div class="alert alert-danger mb-0">
                                    <i class="bi bi-exclamation-octagon-fill me-2"></i>
                                    <strong>¡PRODUCTO VENCIDO!</strong> Este lote expiró hace @Math.Abs(diasParaVencer) día(s). 
                                    Debe ser retirado inmediatamente del inventario.
                                </div>
                            }
                            else if (diasParaVencer <= 7)
                            {
                                <div class="alert alert-danger mb-0">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <strong>¡URGENTE!</strong> Este lote vence en @diasParaVencer día(s). 
                                    Se recomienda priorizar su venta o uso.
                                </div>
                            }
                            else if (diasParaVencer <= 30)
                            {
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-clock-fill me-2"></i>
                                    <strong>Atención:</strong> Este lote vence en @diasParaVencer día(s). 
                                    Considere promociones o descuentos para su rotación.
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Card: Lista de Lotes -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>
                            Todos los Lotes Disponibles
                            @if (lotes != null && lotes.Any())
                            {
                                <span class="badge bg-light text-dark ms-2">@lotes.Count lote(s)</span>
                            }
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        @if (lotes != null && lotes.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>
                                                <i class="bi bi-hash me-1"></i>
                                                ID Lote
                                            </th>
                                            <th>
                                                <i class="bi bi-calendar-check me-1"></i>
                                                Fecha Compra
                                            </th>
                                            <th>
                                                <i class="bi bi-calendar-x me-1"></i>
                                                Fecha Expiración
                                            </th>
                                            <th>
                                                <i class="bi bi-cash me-1"></i>
                                                Precio Costo
                                            </th>
                                            <th>
                                                <i class="bi bi-box me-1"></i>
                                                Disponible
                                            </th>
                                            <th class="text-center">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var lote in lotes.OrderBy(l => l.FechaExpiracion ?? DateTime.MaxValue))
                                        {
                                            var esPrioritario = producto.LotePrioritario == lote.LoteId.ToString();
                                            var diasVencer = lote.FechaExpiracion.HasValue 
                                                ? (lote.FechaExpiracion.Value.Date - DateTime.Today).Days 
                                                : int.MaxValue;
                                            var colorFila = esPrioritario ? "table-warning" : "";

                                            <tr class="@colorFila">
                                                <td>
                                                    <strong class="@(esPrioritario ? "text-warning" : "")">
                                                        @if (esPrioritario)
                                                        {
                                                            <i class="bi bi-star-fill me-1"></i>
                                                        }
                                                        @lote.LoteId
                                                    </strong>
                                                </td>
                                                <td>@lote.FechaCompra.ToString("dd/MM/yyyy")</td>
                                                <td>
                                                    @if (lote.FechaExpiracion.HasValue)
                                                    {
                                                        <span class="text-@(diasVencer < 0 ? "danger" : diasVencer <= 30 ? "warning" : "muted")">
                                                            @lote.FechaExpiracion.Value.ToString("dd/MM/yyyy")
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted fst-italic">Sin fecha</span>
                                                    }
                                                </td>
                                                <td class="fw-bold">$@lote.PrecioCosto.ToString("N2")</td>
                                                <td>
                                                    <span class="badge @(lote.CantidadDisponible > 0 ? "bg-success" : "bg-secondary")">
                                                        @lote.CantidadDisponible
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    @if (diasVencer < 0)
                                                    {
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                            VENCIDO
                                                        </span>
                                                    }
                                                    else if (diasVencer <= 7)
                                                    {
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                            @diasVencer días
                                                        </span>
                                                    }
                                                    else if (diasVencer <= 30)
                                                    {
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="bi bi-clock-fill me-1"></i>
                                                            @diasVencer días
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                            @diasVencer días
                                                        </span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0 mx-3 my-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Este producto no tiene lotes disponibles en el inventario.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private ProductoDto? producto;
    private List<LoteDto>? lotes;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargando = true;
            producto = await ProductoService.ObtenerPorIdAsync(Id);
            lotes = (await LoteService.ObtenerLotesPorProductoAsync(Id))?.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar producto: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void Volver()
    {
        Navigation.NavigateTo("/productos");
    }

    private string ObtenerColorAlerta(int diasParaVencer)
    {
        if (diasParaVencer < 0) return "danger";
        if (diasParaVencer <= 7) return "danger";
        if (diasParaVencer <= 30) return "warning";
        return "success";
    }

    private string ObtenerIconoAlerta(int diasParaVencer)
    {
        if (diasParaVencer < 0) return "bi-x-octagon-fill";
        if (diasParaVencer <= 7) return "bi-exclamation-triangle-fill";
        if (diasParaVencer <= 30) return "bi-clock-history";
        return "bi-check-circle-fill";
    }

    private string ObtenerMensajeVencimiento(int diasParaVencer)
    {
        if (diasParaVencer < 0) return $"VENCIDO hace {Math.Abs(diasParaVencer)} días";
        if (diasParaVencer == 0) return "VENCE HOY";
        if (diasParaVencer == 1) return "VENCE MAÑANA";
        if (diasParaVencer <= 7) return $"Vence en {diasParaVencer} días";
        if (diasParaVencer <= 30) return $"{diasParaVencer} días restantes";
        return $"{diasParaVencer} días de vigencia";
    }
}