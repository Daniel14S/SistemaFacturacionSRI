@page "/productos"
@using SistemaFacturacionSRI.Application.DTOs.Producto
@using SistemaFacturacionSRI.Application.Interfaces.Services
@inject IProductoService ProductoService
@inject NavigationManager Navigation

<PageTitle>Productos</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Gestión de Productos</h3>
    <NavLink class="btn btn-sm btn-primary" href="/productos/nuevo">
        <i class="bi bi-plus-circle"></i> Nuevo producto
    </NavLink>
    </div>



    <!-- Filtros de búsqueda -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Buscar por nombre:</label>
                    <input type="text" class="form-control" @bind="textoBusqueda" @bind:event="oninput" placeholder="Ingrese el nombre del producto...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filtrar por stock:</label>
                    <select class="form-select" @bind="filtroStock">
                        <option value="todos">Todos</option>
                        <option value="conStock">Con Stock</option>
                        <option value="sinStock">Sin Stock</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ordenar por:</label>
                    <select class="form-select" @bind="ordenamiento">
                        <option value="nombre">Nombre</option>
                        <option value="codigo">Código</option>
                        <option value="precio">Precio</option>
                        <option value="stock">Stock</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (productos == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (!ProductosFiltrados.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No se encontraron productos con los filtros aplicados.
        </div>
    }
    else
    {
        <div class="alert alert-secondary">
            Mostrando <strong>@ProductosFiltrados.Count()</strong> de <strong>@productos.Count</strong> productos
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Código</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>IVA</th>
                        <th>Precio con IVA</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var producto in ProductosFiltrados)
                    {
                        <tr>
                            <td>@producto.Codigo</td>
                            <td>@producto.Nombre</td>
                            <td>$@producto.Precio.ToString("N2")</td>
                            <td>@producto.TipoIVADescripcion</td>
                            <td>$@producto.PrecioConIVA.ToString("N2")</td>
                            <td>
                                <span class="badge @(producto.TieneStock ? "bg-success" : "bg-danger")">
                                    @producto.Stock
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" @onclick="() => EditarProducto(producto.Id)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => EliminarProducto(producto.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<ProductoDto>? productos;
    private string textoBusqueda = string.Empty;
    private string filtroStock = "todos";
    private string ordenamiento = "nombre";

    private IEnumerable<ProductoDto> ProductosFiltrados
    {
        get
        {
            if (productos == null)
                return Enumerable.Empty<ProductoDto>();

            var resultado = productos.AsEnumerable();

            // Filtro por texto de búsqueda
            if (!string.IsNullOrWhiteSpace(textoBusqueda))
            {
                resultado = resultado.Where(p => 
                    p.Nombre.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ||
                    p.Codigo.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase)
                );
            }

            // Filtro por stock
            resultado = filtroStock switch
            {
                "conStock" => resultado.Where(p => p.TieneStock),
                "sinStock" => resultado.Where(p => !p.TieneStock),
                _ => resultado
            };

            // Ordenamiento
            resultado = ordenamiento switch
            {
                "codigo" => resultado.OrderBy(p => p.Codigo),
                "precio" => resultado.OrderBy(p => p.Precio),
                "stock" => resultado.OrderByDescending(p => p.Stock),
                _ => resultado.OrderBy(p => p.Nombre)
            };

            return resultado;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
    }

    private async Task CargarProductos()
    {
        var resultado = await ProductoService.ObtenerTodosAsync();
        productos = resultado.ToList();
    }

    private void NuevoProducto()
    {
        Navigation.NavigateTo("/productos/nuevo");
    }

    private void EditarProducto(int id)
    {
        Navigation.NavigateTo($"/productos/editar/{id}");
    }

    private async Task EliminarProducto(int id)
    {
        // TODO: Implementar confirmación antes de eliminar
        await ProductoService.EliminarAsync(id);
        await CargarProductos();
    }
}